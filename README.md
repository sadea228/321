# Крэк-Нолик (@CrackNolikBot)

Телеграм-бот для игры в крестики-нолики в групповых чатах. Предлагает игру 3x3 с различными темами оформления, возможностью игры против ИИ и VIP-функциями.

![Версия](https://img.shields.io/badge/версия-1.0.0-blue)
![Python](https://img.shields.io/badge/Python-3.9+-green)
![License](https://img.shields.io/badge/лицензия-MIT-orange)

## Функциональность

- Игра в крестики-нолики 3x3
- Работа в групповых чатах
- Случайный выбор первого игрока
- Проверка победителя и ничьи
- Различные темы оформления игрового поля
- Игра против ИИ (алгоритм Minimax)
- VIP-аккаунты с дополнительными возможностями
- Административная панель

## Команды бота

### Основные команды
- `/start` - Приветственное сообщение с инструкциями
- `/newgame` - Начать новую игру в текущем чате
- `/play_ai` - Играть против ИИ
- `/themes` - Выбрать тему оформления
- `/resetgame` - Сбросить текущую игру
- `/chatstats` - Посмотреть статистику чата

### VIP-команды
- `/vip` - Получить VIP-подписку
- `/setavatar` - Установить персональный аватар
- `/setsignature` - Установить подпись
- `/setsymbol` - Установить персональный символ
- `/viphelp` - Справка по VIP-функциям

### Административные команды
- `/ban` - Забанить пользователя
- `/unban` - Разбанить пользователя
- `/reset` - Сбросить игру в чате
- `/admin` - Открыть административную панель
- `/setvip` - Выдать VIP-статус пользователю

## Требования к системе

- Python 3.9 или выше
- pip (менеджер пакетов Python)
- Доступ к интернету для взаимодействия с API Telegram
- Платформа для хостинга (опционально)

## Детальная установка и настройка

### 1. Получение токена бота

1. Откройте Telegram и найдите [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot` и следуйте инструкциям для создания нового бота
3. После создания вы получите токен для API - сохраните его для дальнейшей настройки

### 2. Настройка проекта

#### Клонирование репозитория и настройка окружения
```bash
# Клонируем репозиторий (или загрузите ZIP-архив)
git clone https://github.com/your-username/crack-nolik-bot.git
cd crack-nolik-bot

# Создаем виртуальное окружение
python -m venv venv

# Активируем виртуальное окружение
# Для Windows:
venv\Scripts\activate
# Для Linux/Mac:
source venv/bin/activate

# Устанавливаем зависимости
pip install -r requirements.txt
```

### 3. Настройка переменных окружения

Создайте файл `.env` в корне проекта со следующим содержимым:

```
# Основные настройки
TOKEN=ваш_токен_от_botfather
PORT=8080

# Для продакшена с вебхуком
RENDER_EXTERNAL_URL=https://ваш-домен.com

# Для платежей (если используется)
CRYPTO_TOKEN=ваш_токен_cryptopay

# Для базы данных (при необходимости)
DATABASE_URL=postgres://user:password@hostname:5432/dbname
```

### 4. Запуск бота

#### Локальный запуск для разработки и тестирования
```bash
python main.py
```

#### Настройка для хостинга на Render

1. Создайте новый Web Service в панели Render
2. Настройте деплой из вашего GitHub-репозитория
3. Установите Environment Variables (переменные окружения) в панели Render:
   - `TOKEN`: токен вашего бота
   - `PORT`: 8080 (или другой предпочтительный порт)
   - `RENDER_EXTERNAL_URL`: URL, который предоставляет Render
   - Другие необходимые переменные окружения

4. Настройте команду запуска:
   - Build Command: `pip install -r requirements.txt`
   - Start Command: `python main.py`

### 5. Настройка базы данных

#### SQLite (для локальной разработки)

Бот по умолчанию использует хранение данных в памяти, но вы можете настроить SQLite:

```python
# Пример кода для подключения к SQLite
import sqlite3

conn = sqlite3.connect('data.db')
# Далее - создание таблиц и работа с базой данных
```

#### PostgreSQL (для продакшена)

Для хостинга на Render рекомендуется использовать PostgreSQL:

1. Создайте новый PostgreSQL database в панели Render
2. Скопируйте предоставленный Internal Database URL
3. Добавьте его как переменную окружения `DATABASE_URL`
4. В коде используйте:

```python
import os
from sqlalchemy import create_engine

DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///data.db")
engine = create_engine(DATABASE_URL)
```

## Структура проекта

```
crack-nolik-bot/
├── main.py            # Основной файл запуска бота
├── config.py          # Конфигурация и константы
├── game_logic.py      # Логика игры
├── game_ai.py         # ИИ для игры
├── game_state.py      # Состояние игр
├── bot_state.py       # Состояние бота
├── vip.py             # VIP-функциональность
├── requirements.txt   # Зависимости
├── Procfile           # Для деплоя (Render, Heroku)
├── handlers/          # Обработчики команд и событий
│   ├── __init__.py
│   ├── game_handlers.py
│   ├── theme_handlers.py
│   ├── admin_handlers.py
│   ├── ai_handlers.py
│   ├── vip_handlers.py
│   └── admin_panel_handlers.py
└── README.md          # Документация
```

## Как играть

1. Добавьте бота в групповой чат
2. Отправьте команду `/newgame` для начала игры
3. Бот отобразит игровое поле с 9 кнопками (3x3)
4. Первый игрок выбирается случайно
5. Игроки по очереди нажимают на кнопки, чтобы сделать ход
6. Бот автоматически определяет победителя или ничью и завершает игру
7. В любой момент можно использовать `/resetgame` для сброса игры
8. Используйте `/themes` для выбора другой темы оформления

## Технические детали

- Бот написан на Python с использованием библиотеки python-telegram-bot 20.x
- FastAPI используется для создания веб-сервера (для вебхука)
- Uvicorn в качестве ASGI-сервера
- Используется асинхронный подход с async/await
- Состояние игры хранится в словаре по chat_id (в памяти)
- Алгоритм Minimax для ИИ

## VIP-функциональность

Пользователи с VIP-статусом получают доступ к:
- Установке персонального аватара в игре
- Добавлению подписи под сообщениями игры
- Использованию уникального символа вместо X/O
- Приоритетной поддержке

Для получения VIP-статуса используйте команду `/vip` или обратитесь к администратору.

## Сохранение состояния (База данных)

По умолчанию бот хранит игры и статистику в памяти, что удобно для локального тестирования, но данные теряются при перезапуске или деплое.

### SQLite
- Используется файл `data.db` в корне проекта.
- Подходит для локального запуска, но на бесплатном тарифе Render файловая система эфемерна, и данные сбрасываются после обновления сервиса.

### PostgreSQL на Render
- Рекомендуется использовать бесплатный Managed PostgreSQL от Render (до 100 МБ).
- Создайте базу через панель Render и укажите переменную окружения `DATABASE_URL`, например:
  ```
  postgres://user:password@hostname:5432/dbname
  ```
- Для подключения рекомендуется использовать SQLAlchemy:
  ```python
  from sqlalchemy import create_engine
  DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///data.db")
  engine = create_engine(DATABASE_URL)
  ```

## Устранение неполадок

### Частые проблемы и их решения

1. **Бот не запускается**
   - Проверьте правильность токена в .env файле
   - Убедитесь, что все зависимости установлены
   - Проверьте логи на наличие ошибок

2. **Ошибка вебхука**
   - Убедитесь, что URL доступен извне
   - Проверьте настройки WEBHOOK_ENDPOINT_URL
   - Обновите webhook через BotFather

3. **Проблемы с базой данных**
   - Проверьте строку подключения
   - Убедитесь, что база данных создана
   - Проверьте доступность сервера базы данных

4. **Бот не отвечает на команды**
   - Проверьте, активен ли бот через @BotFather
   - Убедитесь, что команды зарегистрированы
   - Проверьте права бота в группе

## Развитие проекта

Планы по развитию:
- Добавление рейтинговой системы
- Расширение размеров поля до 5x5
- Турниры между игроками
- Интеграция с другими платформами

## Лицензия

Этот проект распространяется под лицензией MIT. См. файл LICENSE для получения подробной информации. 